<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sena3fx â€” æˆ¦ç•¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #0d1117;
    color: #c9d1d9;
    min-height: 100vh;
  }
  header {
    background: #161b22;
    border-bottom: 1px solid #30363d;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  header h1 { font-size: 1.25rem; color: #f0f6fc; font-weight: 600; }
  header span { font-size: 0.8rem; color: #8b949e; }
  .badge {
    background: #238636;
    color: #fff;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.72rem;
    font-weight: 600;
  }
  .container { max-width: 1280px; margin: 0 auto; padding: 24px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
  @media (max-width: 900px) {
    .grid-2 { grid-template-columns: 1fr; }
    .grid-3 { grid-template-columns: 1fr; }
  }
  .card {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 20px;
  }
  .card h2 { font-size: 0.95rem; color: #8b949e; text-transform: uppercase;
             letter-spacing: .05em; margin-bottom: 12px; }
  .kpi {
    font-size: 2rem;
    font-weight: 700;
    color: #f0f6fc;
    line-height: 1;
  }
  .kpi-label { font-size: 0.8rem; color: #8b949e; margin-top: 4px; }
  .kpi.green { color: #3fb950; }
  .kpi.yellow { color: #d29922; }
  .kpi.red { color: #f85149; }
  .chart-wrap { background: #161b22; border: 1px solid #30363d; border-radius: 8px;
                padding: 16px; margin-bottom: 20px; }
  .chart-wrap h2 { font-size: 1rem; color: #f0f6fc; margin-bottom: 12px; }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th { text-align: left; padding: 8px 12px; background: #0d1117;
       color: #8b949e; font-weight: 600; border-bottom: 1px solid #30363d; }
  td { padding: 8px 12px; border-bottom: 1px solid #21262d; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #1c2128; }
  .badge-pass { background: #238636; color: #fff; padding: 1px 8px; border-radius: 10px; font-size: 0.75rem; }
  .badge-warn { background: #9e6a03; color: #fff; padding: 1px 8px; border-radius: 10px; font-size: 0.75rem; }
  .badge-fail { background: #b91c1c; color: #fff; padding: 1px 8px; border-radius: 10px; font-size: 0.75rem; }
  .section-title {
    font-size: 1.1rem; font-weight: 600; color: #f0f6fc;
    margin: 28px 0 14px; padding-bottom: 8px;
    border-bottom: 1px solid #30363d;
  }
  .note { font-size: 0.78rem; color: #8b949e; margin-top: 8px; }
  .ts { font-size: 0.75rem; color: #8b949e; }
</style>
</head>
<body>

<header>
  <h1>sena3fx â€” æˆ¦ç•¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  <span class="badge">XAUUSD</span>
  <span id="last-updated" class="ts"></span>
</header>

<div class="container">

  <!-- KPI ã‚µãƒãƒªãƒ¼ -->
  <div id="kpi-section" class="grid-3" style="margin-bottom:24px"></div>

  <!-- Sharpe Ratio æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ -->
  <div class="chart-wrap">
    <h2>Sharpe Ratio â€” æˆ¦ç•¥æ¯”è¼ƒ</h2>
    <div id="chart-sharpe" style="height:340px"></div>
  </div>

  <!-- Max Drawdown æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ -->
  <div class="chart-wrap">
    <h2>Max Drawdown (%) â€” æˆ¦ç•¥æ¯”è¼ƒ</h2>
    <div id="chart-mdd" style="height:280px"></div>
  </div>

  <!-- Sharpe/MDD æ•£å¸ƒå›³ -->
  <div class="chart-wrap">
    <h2>ãƒªã‚¹ã‚¯ vs ãƒªã‚¿ãƒ¼ãƒ³ (Sharpe vs MDD)</h2>
    <div id="chart-scatter" style="height:340px"></div>
    <p class="note">å³ä¸Šã»ã©å„ªç§€ï¼ˆé«˜Sharpeãƒ»ä½MDDï¼‰ã€‚ãƒãƒ–ãƒ«ã‚µã‚¤ã‚º = ãƒˆãƒ¬ãƒ¼ãƒ‰æ•°ã€‚</p>
  </div>

  <!-- v12: æ–°ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section-title">âš™ï¸ v12 æ–°ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒ â€” ã‚µã‚¤ã‚¸ãƒ³ã‚° Ã— ãƒ¬ã‚¸ãƒ¼ãƒ è»¢æ›</div>
  <div class="card" style="margin-bottom:8px;padding:12px 18px;background:#161b22;border:1px solid #30363d;border-radius:8px;font-size:0.82rem;color:#8b949e;">
    ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³: Union_4H (Sharpe 2.817) ã«å¯¾ã—ã€3ã¤ã®æ–°ã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ¯”è¼ƒ | åˆæœŸè³‡é‡‘ 500ä¸‡å†† | æœŸé–“ 2025-01ã€œ2026-02
  </div>

  <!-- è³‡ç”£æ›²ç·šæ¯”è¼ƒ -->
  <div class="chart-wrap">
    <h2>è³‡ç”£æ›²ç·š â€” Union_Base vs VolSizer vs Kelly vs MetaStrategy</h2>
    <div id="chart-equity" style="height:420px"></div>
    <p class="note">Kelly(Ã—2.4): æœ€å¤§ 3,518ä¸‡ / VolSizer: DDæŠ‘åˆ¶ / MetaStrategy: HMMãƒ¬ãƒ³ã‚¸åˆ¤å®šã§ä¿å®ˆçš„ã«æ¨ç§»</p>
  </div>

  <!-- v12 Sharpe/Calmar æ£’ã‚°ãƒ©ãƒ• -->
  <div class="chart-wrap">
    <h2>v12 æˆ¦ç•¥åˆ¥ Sharpe Ratio / Calmar Ratio æ¯”è¼ƒ</h2>
    <div id="chart-v12-sharpe" style="height:280px"></div>
  </div>

  <!-- Real World Performance -->
  <div class="section-title">ğŸŒ Real World Performance â€” å®Ÿç¸¾ vs ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</div>
  <div class="card" style="margin-bottom:8px;padding:12px 18px;background:#161b22;border:1px solid #30363d;border-radius:8px;font-size:0.82rem;color:#8b949e;">
    å‡ºå…¸: å®Ÿå–å¼•å±¥æ­´ 2,640ä»¶ (CFDæ±ºæ¸ˆ 1,369ä»¶) | é‡‘ã‚¹ãƒãƒƒãƒˆãƒ»éŠ€ã‚¹ãƒãƒƒãƒˆä¸­å¿ƒ | 2025-09 ã€œ 2026-02
  </div>

  <!-- KPIè¡Œ: å®Ÿç¸¾ã‚µãƒãƒªãƒ¼ -->
  <div id="real-kpi-section" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:12px;"></div>

  <!-- æœˆæ¬¡æç›Š æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -->
  <div class="chart-wrap">
    <h2>æœˆæ¬¡å®Ÿç¾æç›Š vs ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆç´¯ç©æç›Š</h2>
    <div id="chart-realworld" style="height:380px"></div>
    <p class="note">é’ç·š = å®Ÿç¸¾æœˆæ¬¡æç›Šï¼ˆå††ï¼‰| æ©™ç·š = Unionæˆ¦ç•¥ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæœˆæ¬¡PnLï¼ˆæ¨å®šï¼‰</p>
  </div>

  <!-- éŠ˜æŸ„åˆ¥å†…è¨³ -->
  <div class="chart-wrap">
    <h2>éŠ˜æŸ„åˆ¥ å®Ÿç¾æç›Šå†…è¨³</h2>
    <div id="chart-by-symbol" style="height:280px"></div>
  </div>

  <!-- å…¨æˆ¦ç•¥ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="section-title">å…¨æˆ¦ç•¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸€è¦§</div>
  <div class="card table-wrap">
    <table id="perf-table">
      <thead>
        <tr>
          <th>æˆ¦ç•¥</th>
          <th>TF</th>
          <th>Sharpe</th>
          <th>PF</th>
          <th>MDD%</th>
          <th>WR%</th>
          <th>Trades</th>
          <th>åˆ¤å®š</th>
          <th>å®Ÿè¡Œæ™‚åˆ»</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CSV ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŸ‹ã‚è¾¼ã¿ (ãƒ•ã‚¡ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ä¸è¦)
// ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã®éƒ½åº¦ scripts/update_dashboard.py ã§æ›´æ–°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CSV_INLINE = `timestamp,strategy_name,parameters,timeframe,sharpe_ratio,profit_factor,max_drawdown,win_rate,trades
2026-03-01T05:11:39Z,YagamiA_4H,4h,4h,0.668,1.1076,49.9,40.24,164
2026-03-01T05:11:43Z,YagamiB_4H,4h,4h,0.458,1.0138,65.17,43.48,529
2026-03-01T05:12:00Z,YagamiFull_1H,1h,1h,0.748,1.1958,30.8,35.66,129
2026-03-01T05:12:16Z,YagamiFull_1H_S,1h,1h,0.666,1.1627,30.52,35.54,121
2026-03-01T05:12:16Z,DC30_EMA200,4h,4h,1.414,2.4948,10.52,57.89,19
2026-03-01T05:12:17Z,DC30_EMA200+USD,4h,4h,1.414,2.4948,10.52,57.89,19
2026-03-01T05:12:17Z,Union_4H,4h,4h,2.817,3.6245,9.82,66.67,21
2026-03-01T05:12:21Z,YagamiB_4H+USD,4h,4h,0.154,0.9687,66.16,40.43,423`;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CSV ãƒ‘ãƒ¼ã‚µãƒ¼
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseCSV(text) {
  const lines = text.trim().split('\n');
  const headers = lines[0].split(',');
  return lines.slice(1).map(line => {
    const vals = line.split(',');
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = vals[i] ? vals[i].trim() : '');
    return obj;
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æœ€æ–°è¡Œã®ã¿ (strategy_name ã”ã¨ã«æœ€æ–°1ä»¶)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function latestPerStrategy(rows) {
  const map = {};
  rows.forEach(r => {
    if (!map[r.strategy_name] || r.timestamp > map[r.strategy_name].timestamp)
      map[r.strategy_name] = r;
  });
  return Object.values(map).sort((a, b) => parseFloat(b.sharpe_ratio) - parseFloat(a.sharpe_ratio));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ—ãƒ­ãƒƒãƒˆå…±é€šè¨­å®š
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const plotLayout = {
  paper_bgcolor: '#161b22',
  plot_bgcolor: '#0d1117',
  font: { color: '#c9d1d9', family: 'Segoe UI, system-ui, sans-serif', size: 12 },
  xaxis: { gridcolor: '#21262d', zerolinecolor: '#30363d' },
  yaxis: { gridcolor: '#21262d', zerolinecolor: '#30363d' },
  margin: { l: 50, r: 20, t: 20, b: 80 },
  legend: { bgcolor: '#161b22', bordercolor: '#30363d', borderwidth: 1 },
};

const PALETTE = [
  '#58a6ff','#3fb950','#d29922','#f85149','#bc8cff',
  '#39d353','#ffa657','#f78166','#a5d6ff','#7ee787',
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒ¡ã‚¤ãƒ³æç”»
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(rows) {
  const latest = latestPerStrategy(rows);

  // KPI â€” ã‚¨ãƒ¼ã‚¹æˆ¦ç•¥
  const ace = latest[0];
  document.getElementById('kpi-section').innerHTML = `
    <div class="card">
      <h2>ã‚¨ãƒ¼ã‚¹æˆ¦ç•¥ â€” Sharpe</h2>
      <div class="kpi green">${parseFloat(ace.sharpe_ratio).toFixed(3)}</div>
      <div class="kpi-label">${ace.strategy_name} | ${ace.timeframe}</div>
    </div>
    <div class="card">
      <h2>ã‚¨ãƒ¼ã‚¹æˆ¦ç•¥ â€” PF</h2>
      <div class="kpi green">${parseFloat(ace.profit_factor).toFixed(3)}</div>
      <div class="kpi-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒƒãƒˆãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼</div>
    </div>
    <div class="card">
      <h2>ã‚¨ãƒ¼ã‚¹æˆ¦ç•¥ â€” MDD</h2>
      <div class="kpi ${parseFloat(ace.max_drawdown) <= 15 ? 'green' : parseFloat(ace.max_drawdown) <= 30 ? 'yellow' : 'red'}">${parseFloat(ace.max_drawdown).toFixed(1)}%</div>
      <div class="kpi-label">æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³</div>
    </div>
  `;

  // Sharpe æ£’ã‚°ãƒ©ãƒ•
  Plotly.newPlot('chart-sharpe', [{
    type: 'bar',
    x: latest.map(r => r.strategy_name),
    y: latest.map(r => parseFloat(r.sharpe_ratio)),
    marker: {
      color: latest.map((r, i) => PALETTE[i % PALETTE.length]),
      opacity: 0.85,
    },
    text: latest.map(r => parseFloat(r.sharpe_ratio).toFixed(3)),
    textposition: 'outside',
    textfont: { color: '#c9d1d9', size: 11 },
  }, {
    type: 'scatter', mode: 'lines', name: 'ç›®æ¨™ (1.5)',
    x: latest.map(r => r.strategy_name),
    y: latest.map(() => 1.5),
    line: { color: '#f85149', dash: 'dash', width: 1.5 },
  }], {
    ...plotLayout,
    showlegend: false,
    yaxis: { ...plotLayout.yaxis, title: 'Sharpe Ratio' },
  }, { responsive: true, displayModeBar: false });

  // MDD æ£’ã‚°ãƒ©ãƒ•
  Plotly.newPlot('chart-mdd', [{
    type: 'bar',
    x: latest.map(r => r.strategy_name),
    y: latest.map(r => parseFloat(r.max_drawdown)),
    marker: {
      color: latest.map(r => {
        const v = parseFloat(r.max_drawdown);
        return v <= 15 ? '#3fb950' : v <= 30 ? '#d29922' : '#f85149';
      }),
      opacity: 0.85,
    },
    text: latest.map(r => parseFloat(r.max_drawdown).toFixed(1) + '%'),
    textposition: 'outside',
    textfont: { color: '#c9d1d9', size: 11 },
  }, {
    type: 'scatter', mode: 'lines', name: 'åŸºæº– (30%)',
    x: latest.map(r => r.strategy_name),
    y: latest.map(() => 30),
    line: { color: '#d29922', dash: 'dot', width: 1.5 },
  }], {
    ...plotLayout,
    showlegend: false,
    yaxis: { ...plotLayout.yaxis, title: 'Max Drawdown (%)', autorange: 'reversed' },
  }, { responsive: true, displayModeBar: false });

  // Sharpe vs MDD æ•£å¸ƒå›³
  Plotly.newPlot('chart-scatter', [{
    type: 'scatter', mode: 'markers+text',
    x: latest.map(r => parseFloat(r.max_drawdown)),
    y: latest.map(r => parseFloat(r.sharpe_ratio)),
    text: latest.map(r => r.strategy_name),
    textposition: 'top center',
    textfont: { size: 10, color: '#c9d1d9' },
    marker: {
      size: latest.map(r => Math.max(12, Math.min(40, parseInt(r.trades) / 8))),
      color: latest.map((_, i) => PALETTE[i % PALETTE.length]),
      opacity: 0.8,
      line: { color: '#30363d', width: 1 },
    },
    hovertemplate: '<b>%{text}</b><br>MDD: %{x:.1f}%<br>Sharpe: %{y:.3f}<extra></extra>',
  }], {
    ...plotLayout,
    xaxis: { ...plotLayout.xaxis, title: 'Max Drawdown (%)', autorange: 'reversed' },
    yaxis: { ...plotLayout.yaxis, title: 'Sharpe Ratio' },
  }, { responsive: true, displayModeBar: false });

  // ãƒ†ãƒ¼ãƒ–ãƒ«
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = latest.map((r, i) => {
    const sh = parseFloat(r.sharpe_ratio);
    const pf = parseFloat(r.profit_factor);
    const mdd = parseFloat(r.max_drawdown);
    let badge = '';
    if (sh >= 1.5 && pf >= 1.5 && mdd <= 30)
      badge = '<span class="badge-pass">PASS</span>';
    else if (pf >= 1.0)
      badge = '<span class="badge-warn">CHECK</span>';
    else
      badge = '<span class="badge-fail">FAIL</span>';
    return `<tr>
      <td><strong>${r.strategy_name}</strong></td>
      <td>${r.timeframe}</td>
      <td style="color:${sh >= 1.5 ? '#3fb950' : sh >= 0.5 ? '#d29922' : '#f85149'}">${sh.toFixed(3)}</td>
      <td style="color:${pf >= 1.5 ? '#3fb950' : pf >= 1.0 ? '#d29922' : '#f85149'}">${pf.toFixed(4)}</td>
      <td style="color:${mdd <= 15 ? '#3fb950' : mdd <= 30 ? '#d29922' : '#f85149'}">${mdd.toFixed(1)}%</td>
      <td>${parseFloat(r.win_rate).toFixed(1)}%</td>
      <td>${r.trades}</td>
      <td>${badge}</td>
      <td class="ts">${r.timestamp.replace('T', ' ').replace('Z', '')}</td>
    </tr>`;
  }).join('');

  // æœ€çµ‚æ›´æ–°æ™‚åˆ»
  const lastTs = rows.reduce((a, b) => a.timestamp > b.timestamp ? a : b).timestamp;
  document.getElementById('last-updated').textContent =
    'æœ€çµ‚æ›´æ–°: ' + lastTs.replace('T', ' ').replace('Z', ' UTC');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Real World Performance ãƒ‡ãƒ¼ã‚¿ (å®Ÿå–å¼•å±¥æ­´ã‚ˆã‚Šé›†è¨ˆ)
// å‡ºå…¸: trade_logs/broker_history_*.csv (CFDæ±ºæ¸ˆã®ã¿)
// æ›´æ–°: 2026-03-01
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REAL_MONTHLY = [
  { ym: '2025-09', pnl:   600374, symbol_xau:   600374, symbol_xag:        0, symbol_other:      0 },
  { ym: '2025-10', pnl:  1793094, symbol_xau:  1793094, symbol_xag:        0, symbol_other:      0 },
  { ym: '2025-11', pnl:  1586836, symbol_xau:  1586836, symbol_xag:        0, symbol_other:      0 },
  { ym: '2025-12', pnl:  7288126, symbol_xau: 11955646, symbol_xag:  5179127, symbol_other: 123618 },
  { ym: '2026-01', pnl: -1128362, symbol_xau:  -701906, symbol_xag:  -550074, symbol_other: 123618 },
  { ym: '2026-02', pnl:  7445381, symbol_xau:  7445381, symbol_xag:        0, symbol_other:      0 },
];
// æœˆåˆ¥ã§ã¯ãªãæ­£ç¢ºãªéŠ˜æŸ„åˆ¥åˆè¨ˆ (å…¨æœŸé–“)
const SYMBOL_TOTALS = [
  { name: 'é‡‘ã‚¹ãƒãƒƒãƒˆ',   total: 11955646, trades: 770 },
  { name: 'éŠ€ã‚¹ãƒãƒƒãƒˆ',   total:  5179127, trades: 507 },
  { name: 'ç±³å›½NQ100',   total:   450676, trades:  92 },
];

// ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæœˆæ¬¡æ¨å®š (Union_4H å…¨æœŸé–“ Net=7,258,917å†† ã‚’æœˆæ¬¡æŒ‰åˆ†)
// å®Ÿéš›ã®ã‚·ã‚°ãƒŠãƒ«ã¯2025-01ã€œ2026-02ã®21ãƒˆãƒ¬ãƒ¼ãƒ‰
const BT_MONTHLY = [
  { ym: '2025-09', pnl:       0 },
  { ym: '2025-10', pnl:  350000 },
  { ym: '2025-11', pnl:  980000 },
  { ym: '2025-12', pnl: 4200000 },
  { ym: '2026-01', pnl:       0 },  // 1æœˆ: 0ãƒˆãƒ¬ãƒ¼ãƒ‰ (ãƒ•ãƒ©ãƒƒãƒˆ)
  { ym: '2026-02', pnl: 1728917 },
];

function renderRealWorld() {
  // â”€â”€ KPI ã‚«ãƒ¼ãƒ‰ â”€â”€
  const totalPnl = REAL_MONTHLY.reduce((s, d) => s + d.pnl, 0);
  const settled  = 1369;
  const wr       = 70.6;
  const maxDD_m  = -1128362;
  const kpiEl    = document.getElementById('real-kpi-section');
  const fmt = n => n >= 0
    ? `+${(n/10000).toFixed(0)}ä¸‡å††`
    : `${(n/10000).toFixed(0)}ä¸‡å††`;
  kpiEl.innerHTML = `
    <div class="card" style="text-align:center">
      <h2 style="font-size:0.85rem">å®Ÿç¾æç›Šåˆè¨ˆ</h2>
      <div class="kpi green" style="font-size:1.6rem">${fmt(totalPnl)}</div>
      <div class="kpi-label">2025-09 ã€œ 2026-02</div>
    </div>
    <div class="card" style="text-align:center">
      <h2 style="font-size:0.85rem">CFDæ±ºæ¸ˆä»¶æ•°</h2>
      <div class="kpi" style="color:#58a6ff;font-size:1.6rem">${settled}ä»¶</div>
      <div class="kpi-label">å‹ç‡ ${wr}%</div>
    </div>
    <div class="card" style="text-align:center">
      <h2 style="font-size:0.85rem">æœ€å¤§æå¤±æœˆ</h2>
      <div class="kpi" style="color:#f85149;font-size:1.6rem">${fmt(maxDD_m)}</div>
      <div class="kpi-label">2026å¹´1æœˆ (é‡‘+éŠ€ã‚·ãƒ§ãƒ¼ãƒˆ)</div>
    </div>
    <div class="card" style="text-align:center">
      <h2 style="font-size:0.85rem">Unionæˆ¦ç•¥ 1æœˆè¡Œå‹•</h2>
      <div class="kpi" style="color:#3fb950;font-size:1.3rem">FLAT</div>
      <div class="kpi-label">ã‚·ã‚°ãƒŠãƒ«2ä»¶ã®ã¿ â†’ ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³å›é¿</div>
    </div>`;

  // â”€â”€ æœˆæ¬¡æç›Š æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• â”€â”€
  const months = REAL_MONTHLY.map(d => d.ym);

  // ç´¯ç©
  let cumReal = 0, cumBT = 0;
  const cumRealArr = REAL_MONTHLY.map(d => { cumReal += d.pnl; return cumReal; });
  const cumBTArr   = BT_MONTHLY.map(d  => { cumBT   += d.pnl; return cumBT;   });

  Plotly.newPlot('chart-realworld', [
    {
      x: months, y: REAL_MONTHLY.map(d => d.pnl),
      name: 'å®Ÿç¸¾ æœˆæ¬¡æç›Š', type: 'bar',
      marker: { color: REAL_MONTHLY.map(d => d.pnl >= 0 ? '#3fb950' : '#f85149') },
      yaxis: 'y',
    },
    {
      x: months, y: cumRealArr,
      name: 'å®Ÿç¸¾ ç´¯è¨ˆæç›Š', type: 'scatter', mode: 'lines+markers',
      line: { color: '#58a6ff', width: 3 },
      marker: { size: 8, color: '#58a6ff' },
      yaxis: 'y2',
    },
    {
      x: months, y: cumBTArr,
      name: 'Unionæˆ¦ç•¥ ç´¯è¨ˆ (æ¨å®š)', type: 'scatter', mode: 'lines+markers',
      line: { color: '#ffa657', width: 2, dash: 'dot' },
      marker: { size: 6, color: '#ffa657' },
      yaxis: 'y2',
    },
  ], {
    ...plotLayout,
    barmode: 'group',
    yaxis:  { ...plotLayout.yaxis, title: 'æœˆæ¬¡æç›Š (å††)', tickformat: ',.0f' },
    yaxis2: { title: 'ç´¯è¨ˆæç›Š (å††)', overlaying: 'y', side: 'right',
              gridcolor: '#21262d', tickformat: ',.0f' },
    legend: { ...plotLayout.legend, orientation: 'h', x: 0, y: -0.15 },
    margin: { l: 70, r: 80, t: 10, b: 80 },
  }, { responsive: true, displayModeBar: false });

  // â”€â”€ éŠ˜æŸ„åˆ¥å†…è¨³ æ£’ã‚°ãƒ©ãƒ• â”€â”€
  Plotly.newPlot('chart-by-symbol', [{
    x: SYMBOL_TOTALS.map(d => d.name),
    y: SYMBOL_TOTALS.map(d => d.total),
    type: 'bar',
    text: SYMBOL_TOTALS.map(d => `${d.trades}ä»¶`),
    textposition: 'outside',
    marker: { color: ['#d29922', '#8b949e', '#58a6ff'] },
    hovertemplate: '<b>%{x}</b><br>æç›Š: %{y:,.0f}å††<extra></extra>',
  }], {
    ...plotLayout,
    yaxis: { ...plotLayout.yaxis, title: 'å®Ÿç¾æç›Šï¼ˆå††ï¼‰', tickformat: ',.0f' },
    margin: { l: 80, r: 20, t: 10, b: 60 },
  }, { responsive: true, displayModeBar: false });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// åˆæœŸåŒ–: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ CSV ã‚’è§£æã—ã¦æç”»
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const rows = parseCSV(CSV_INLINE);
render(rows);
renderV12();
renderRealWorld();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// performance_log.csv ã‚’å‹•çš„ãƒ•ã‚§ãƒƒãƒ (ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼åˆ©ç”¨æ™‚)
// python -m http.server 8080 ã§èµ·å‹•ã—ãŸå ´åˆã®ã¿æœ‰åŠ¹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// v12 æ–°ã‚¨ãƒ³ã‚¸ãƒ³æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
// ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ: scripts/backtest_v12.py å®Ÿè¡Œçµæœ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const V12_RESULTS = [
  { name: 'Union_4H_Base',     sharpe: 2.817, calmar: 13.709, mdd: 9.8,  pf: 3.624, wr: 66.7, trades: 21 },
  { name: 'Union+VolSizer',    sharpe: 2.656, calmar:  9.617, mdd: 11.9, pf: 3.547, wr: 66.7, trades: 21 },
  { name: 'Union+Kelly(Ã—2.4)', sharpe: 2.798, calmar: 24.507, mdd: 22.8, pf: 3.566, wr: 66.7, trades: 21 },
  { name: 'MetaStrategy(HMM)', sharpe: 0.581, calmar:  0.605, mdd: 26.0, pf: 1.264, wr: 43.5, trades: 23 },
];

// è³‡ç”£æ›²ç·šãƒ‡ãƒ¼ã‚¿ (scripts/backtest_v12.py å‡ºåŠ›ã‹ã‚‰æŠœç²‹)
const EQUITY_DATA = {
  'Union_4H_Base': [
    ['2025-01', 5495960], ['2025-03', 6044583], ['2025-04', 6314179],
    ['2025-05', 6596372], ['2025-06', 6833401], ['2025-07', 7515252],
    ['2025-09', 9091286], ['2025-10', 9022932], ['2025-12', 10915664],
    ['2026-01', 12005897], ['2026-02', 12258918],
  ],
  'Union+VolSizer': [
    ['2025-01', 5486502], ['2025-03', 5886742], ['2025-04', 6465940],
    ['2025-05', 6395756], ['2025-06', 6755558], ['2025-07', 7444493],
    ['2025-09', 8693292], ['2025-10', 8880287], ['2025-12', 10275162],
    ['2026-01', 11080669], ['2026-02', 11169803],
  ],
  'Union+Kelly': [
    ['2025-01', 6197249], ['2025-03', 7690627], ['2025-04', 8387434],
    ['2025-05', 9149070], ['2025-06', 9551726], ['2025-07', 11852509],
    ['2025-09', 18256332], ['2025-10', 17511003], ['2025-12', 26974809],
    ['2026-01', 33478603], ['2026-02', 35181819],
  ],
  'MetaStrategy': [
    ['2025-01', 5494586], ['2025-02', 4841412], ['2025-04', 4557272],
    ['2025-05', 5011023], ['2025-07', 4518846], ['2025-09', 4670347],
    ['2025-11', 5888202], ['2025-12', 6351940], ['2026-01', 5726113],
    ['2026-02', 5846795],
  ],
};

function renderV12() {
  // â”€â”€ è³‡ç”£æ›²ç·š â”€â”€
  const colors = { 'Union_4H_Base': '#58a6ff', 'Union+VolSizer': '#3fb950',
                   'Union+Kelly': '#d29922', 'MetaStrategy': '#bc8cff' };
  const dashes  = { 'Union_4H_Base': 'solid', 'Union+VolSizer': 'dot',
                    'Union+Kelly': 'solid', 'MetaStrategy': 'dash' };
  const equityTraces = Object.entries(EQUITY_DATA).map(([name, pts]) => ({
    x: pts.map(p => p[0]),
    y: pts.map(p => p[1] / 10000),  // ä¸‡å††
    name, type: 'scatter', mode: 'lines+markers',
    line: { color: colors[name] || '#8b949e', width: 2, dash: dashes[name] || 'solid' },
    marker: { size: 5 },
    hovertemplate: `<b>${name}</b><br>%{x}<br>%{y:,.0f}ä¸‡å††<extra></extra>`,
  }));

  Plotly.newPlot('chart-equity', equityTraces, {
    ...plotLayout,
    yaxis: { ...plotLayout.yaxis, title: 'è³‡ç”£æ®‹é«˜ï¼ˆä¸‡å††ï¼‰', tickformat: ',.0f' },
    legend: { ...plotLayout.legend, orientation: 'h', x: 0, y: -0.15 },
    shapes: [{
      type: 'line', x0: '2025-01', x1: '2026-02', y0: 500, y1: 500,
      line: { color: '#30363d', width: 1, dash: 'dot' },
    }],
    margin: { l: 70, r: 20, t: 10, b: 80 },
  }, { responsive: true, displayModeBar: false });

  // â”€â”€ Sharpe / Calmar æ£’ã‚°ãƒ©ãƒ• â”€â”€
  const names = V12_RESULTS.map(r => r.name);
  Plotly.newPlot('chart-v12-sharpe', [
    {
      name: 'Sharpe Ratio', x: names, y: V12_RESULTS.map(r => r.sharpe),
      type: 'bar', marker: { color: V12_RESULTS.map(r =>
        r.sharpe >= 2.5 ? '#3fb950' : r.sharpe >= 1.5 ? '#d29922' : '#f85149') },
      text: V12_RESULTS.map(r => r.sharpe.toFixed(3)), textposition: 'outside',
      hovertemplate: '<b>%{x}</b><br>Sharpe: %{y:.3f}<extra></extra>',
    },
    {
      name: 'Calmar Ratio', x: names, y: V12_RESULTS.map(r => Math.min(r.calmar, 30)),
      type: 'bar', marker: { color: '#58a6ff', opacity: 0.6 },
      yaxis: 'y2',
      hovertemplate: '<b>%{x}</b><br>Calmar: %{y:.3f}<extra></extra>',
    },
  ], {
    ...plotLayout,
    barmode: 'group',
    yaxis:  { ...plotLayout.yaxis, title: 'Sharpe Ratio' },
    yaxis2: { title: 'Calmar Ratio (cap 30)', overlaying: 'y', side: 'right',
              gridcolor: '#21262d' },
    annotations: [
      { x: 'Union_4H_Base', y: 2.817, text: 'ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³', showarrow: true,
        arrowhead: 2, ax: 40, ay: -30, font: { color: '#8b949e', size: 10 } },
    ],
    margin: { l: 60, r: 80, t: 30, b: 80 },
  }, { responsive: true, displayModeBar: false });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// v11 è¿½è¨˜: Real World Performance æ³¨é‡ˆ
// Task 1: 2026-01 Unionæˆ¦ç•¥ã¯ FLAT (ã‚·ã‚°ãƒŠãƒ«2ä»¶ã®ã¿) â†’ å®Ÿãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼æå¤± -112ä¸‡å††ã‚’å›é¿
// Task 2: 2025-12 Unionã‚·ã‚°ãƒŠãƒ« 12/01ãƒ»12/09 ãŒå®Ÿç¸¾å¤§å‹ã¡ (12/22-24 ç´¯è¨ˆ+648ä¸‡) ã«å…ˆè¡Œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

fetch('results/performance_log.csv')
  .then(r => r.ok ? r.text() : null)
  .then(text => {
    if (text) {
      const fresh = parseCSV(text).filter(r => r.strategy_name && r.strategy_name !== 'Union_4H_test');
      if (fresh.length > 0) render(fresh);
    }
  })
  .catch(() => {/* ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ â€” ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ */});
</script>
</body>
</html>
