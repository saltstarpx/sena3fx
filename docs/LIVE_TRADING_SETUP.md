# sena3fx ライブトレーディング セットアップガイド

> バックテスト実証済み戦略をWindows 11で24時間自動運用する完全ガイド

---

## 目次

1. [動作確認済み環境](#1-動作確認済み環境)
2. [戦略サマリー](#2-戦略サマリー)
3. [OANDAアカウント開設とAPI設定](#3-oandaアカウント開設とapi設定)
4. [GitHubからダウンロード](#4-githubからダウンロード)
5. [セットアップ手順](#5-セットアップ手順)
6. [config.yaml 設定ガイド](#6-configyaml-設定ガイド)
7. [デモ口座でのテスト](#7-デモ口座でのテスト)
8. [本番起動・停止](#8-本番起動停止)
9. [ログ確認・監視](#9-ログ確認監視)
10. [24時間稼働のためのWindows設定](#10-24時間稼働のためのwindows設定)
11. [リスク管理の重要事項](#11-リスク管理の重要事項)
12. [トラブルシューティング](#12-トラブルシューティング)
13. [よくある質問 (FAQ)](#13-よくある質問-faq)

---

## 1. 動作確認済み環境

| 項目 | 要件 |
|------|------|
| OS | Windows 11 64bit |
| Python | 3.10 以上 |
| 証券会社 | OANDA Japan (oanda.com/jp) |
| 通貨ペア | XAU_USD (金) / XAG_USD (銀) |
| 足種 | 4時間足 |

---

## 2. 戦略サマリー

### Gold (XAU_USD) — `SEAS_DC2d`

| 項目 | 値 |
|------|----|
| シグナル | 2日間ドンチャンチャネル ブレイクアウト |
| フィルター | 6月・7月スキップ (シーズナル) |
| SL | 1.5 × ATR(14) |
| TP | 4.5 × ATR(14) |
| RR比 | 1:3.0 |
| バックテスト結果 (Sep-2025〜Feb-2026, リスク5%) | +195.7% ROI, MaxDD 4.6% |

**ロジック説明:**
- 4H足で「過去2日間 (=12本) の高値を終値が上抜けた」時にロングエントリー
- 6月・7月は金相場がレンジになりやすいためスキップ
- SL/TPはATRベースで相場の振れ幅に合わせて自動調整

### Silver (XAG_USD) — `UNION3d50_SEAS`

| 項目 | 値 |
|------|----|
| シグナル | RSI(14)が50を上抜け & EMA21上 **OR** 3日ドンチャンブレイク |
| フィルター | 6月・7月スキップ |
| SL | 2.0 × ATR(14) |
| TP | 6.0 × ATR(14) |
| RR比 | 1:3.0 |
| バックテスト結果 (Sep-2025〜Feb-2026, リスク5%) | +214.7% ROI, MaxDD 5.1% |

---

## 3. OANDAアカウント開設とAPI設定

### 3-1. アカウント開設

1. [OANDA Japan](https://www.oanda.com/jp-ja/) にアクセス
2. 「口座開設」→「個人口座」を選択
3. デモ口座で試す場合: 「デモ口座開設」を選択 (審査不要、即日利用可)
4. 本番口座: 本人確認書類の提出が必要 (数日かかる場合あり)

> **重要:** 最初は必ずデモ口座でボットの動作を確認してください。

### 3-2. 口座IDの確認

1. OANDAにログイン
2. 右上のアカウントメニュー → 「マイアカウント」
3. 口座一覧に表示される番号が **口座ID**
   - 例: `001-009-12345678-001`

### 3-3. APIキーの生成

1. OANDAにログイン
2. 右上メニュー → 「APIアクセス管理」
3. 「新しいAPIキーを生成」をクリック
4. 生成されたキーをコピーして保管

> **セキュリティ注意:**
> - APIキーは他人に絶対に教えないでください
> - `config.yaml` はGitHubにアップロードしないでください (.gitignoreで除外済み)

---

## 4. GitHubからダウンロード

### 方法A: ZIP でダウンロード (推奨・Gitなし)

1. https://github.com/saltstarpx/sena3fx にアクセス
2. 緑色の「Code」ボタン → 「Download ZIP」
3. ダウンロードしたZIPを展開 (例: `C:\sena3fx\`)

### 方法B: git clone

```cmd
git clone https://github.com/saltstarpx/sena3fx.git
cd sena3fx
```

---

## 5. セットアップ手順

### Step 1: Python インストール (未インストールの場合)

1. https://www.python.org/downloads/ にアクセス
2. 「Download Python 3.12.x」をクリック
3. インストーラーを起動
4. **「Add Python to PATH」にチェックを入れてから「Install Now」**

インストール確認:
```cmd
python --version
# Python 3.12.x と表示されればOK
```

### Step 2: setup.bat を実行

1. `sena3fx` フォルダを開く
2. `setup.bat` をダブルクリック
3. 自動で以下が実行される:
   - 仮想環境 (`venv`) の作成
   - 必要パッケージのインストール (`oandapyV20`, `pandas`, `pyyaml` など)
   - `config.yaml` の生成

```
============================================================
  sena3fx Live Trading Bot - 初回セットアップ
============================================================
[OK] Python が見つかりました: Python 3.12.0
[OK] 仮想環境を作成しました: venv\
[OK] 全パッケージのインストール完了
[OK] config.yaml を作成しました
============================================================
  セットアップ完了！
```

### Step 3: config.yaml を編集

`config.yaml` をメモ帳やVS Codeで開いて編集:

```yaml
oanda:
  account_id: "001-009-12345678-001"    # ← 自分の口座ID
  api_key:    "abc123def456-xxxx..."     # ← 自分のAPIキー
  environment: "practice"               # ← まずデモで確認
```

---

## 6. config.yaml 設定ガイド

### OANDA設定

```yaml
oanda:
  account_id: "001-009-XXXXXXXX-001"  # OANDAダッシュボードで確認
  api_key:    "YOUR_API_KEY"           # APIアクセス管理ページで生成
  environment: "practice"             # デモ: "practice" / 本番: "live"
```

### 通貨ペア設定

```yaml
instruments:
  XAU_USD:
    enabled: true          # true=監視する, false=スキップ
    strategy: "SEAS_DC2d"  # 戦略名 (Gold推奨)
    risk_pct: 0.05         # 1トレードのリスク率 (5%)
    sl_atr: 1.5            # SL = 1.5 × ATR
    tp_atr: 4.5            # TP = 4.5 × ATR
    max_units: 500         # 最大ユニット数 (安全キャップ)
```

### リスク率の目安

| risk_pct | 証拠金1000万円の場合の1トレード最大損失 |
|----------|----------------------------------------|
| 0.02 (2%) | 約20万円 |
| 0.05 (5%) | 約50万円 ← バックテスト推奨 |
| 0.08 (8%) | 約80万円 ← 攻撃的 |

### ドローダウン自動停止

```yaml
bot:
  max_drawdown_pct: 0.15  # 15%のドローダウンで自動停止
```

証拠金1000万円で150万円損失したら自動停止します。
強制停止後はOANDAダッシュボードで状況確認し、手動で判断してください。

---

## 7. デモ口座でのテスト

### テスト手順

1. `config.yaml` の `environment: "practice"` のまま
2. `start_bot.bat` を実行
3. 数時間〜数日間ログを監視
4. 問題なければ本番に切り替え

### 正常動作のログ例

```
2026-02-27 00:01:23 [INFO ] OANDA ブローカー初期化完了 (環境: PRACTICE, 口座: 001-009-...)
2026-02-27 00:01:24 [INFO ] 口座残高: $10,000,000.00
2026-02-27 00:01:24 [INFO ] 監視通貨ペア: ['XAU_USD']
2026-02-27 00:01:24 [INFO ] チェック間隔: 60秒
2026-02-27 04:01:05 [INFO ] [XAU_USD] 新4Hバー確定: 2026-02-27 04:00:00 | 戦略: SEAS_DC2d
2026-02-27 04:01:06 [INFO ] [XAU_USD] シグナル: [FLAT] | Close: 2925.123 | ATR14: 28.456
2026-02-27 08:01:08 [INFO ] [XAU_USD] 新4Hバー確定: 2026-02-27 08:00:00 | 戦略: SEAS_DC2d
2026-02-27 08:01:08 [INFO ] [XAU_USD] シグナル: [LONG] | Close: 2941.200 | ATR14: 29.100
2026-02-27 08:01:09 [INFO ] [XAU_USD] ロング発注:
                              Units:  344
                              Entry:  2941.350
                              SL:     2897.700  (-43.650 / -1.5×ATR)
                              TP:     3072.650  (+131.300 / +4.5×ATR)
                              Risk:   $500,000 (5% of $10,000,000)
2026-02-27 08:01:10 [INFO ] [XAU_USD] 発注完了 ✓ OrderID=12345, 約定価格=2941.380
```

---

## 8. 本番起動・停止

### 起動

```
start_bot.bat をダブルクリック
```

または コマンドプロンプトから:
```cmd
cd C:\sena3fx
start_bot.bat
```

### 停止

```
stop_bot.bat をダブルクリック
```

または `start_bot.bat` が起動したウィンドウで `Ctrl+C`

> **注意:** ボットを停止しても **オープンポジションは自動でクローズされません。**
> 停止後はOANDAダッシュボードでポジションを確認してください。

---

## 9. ログ確認・監視

### ログファイルの場所

```
sena3fx\
  logs\
    bot_20260227.log   ← 今日のログ
    bot_20260226.log   ← 昨日のログ
    ...
```

### リアルタイム確認 (PowerShell)

```powershell
Get-Content C:\sena3fx\logs\bot_20260227.log -Wait -Tail 50
```

### ログレベルの変更

```yaml
# config.yaml
bot:
  log_level: "DEBUG"  # 詳細ログ (問題調査時)
  log_level: "INFO"   # 通常 (推奨)
  log_level: "WARNING"  # 警告・エラーのみ
```

---

## 10. 24時間稼働のためのWindows設定

### 10-1. スリープ・スクリーンセーバー無効化

1. スタートメニュー → 「電源とスリープ」
2. 「スリープ」→「なし」に設定
3. 「ディスプレイ」→「なし」でも可 (表示が消えるだけで動作継続)

### 10-2. タスクスケジューラで自動起動 (PC再起動後も自動起動)

1. スタート → 「タスクスケジューラ」を検索して起動
2. 「タスクの作成」をクリック
3. 設定:
   - **全般タブ**: 「最上位の特権で実行する」にチェック
   - **トリガータブ**: 「新規」→「コンピューターの起動時」
   - **操作タブ**: 「新規」→
     - プログラム: `C:\sena3fx\start_bot.bat`
     - 開始場所: `C:\sena3fx`

### 10-3. 停電・再起動後の確認事項

再起動後は以下を確認:
1. ボットが正常起動しているか (`logs\` の最新ログ確認)
2. OANDAダッシュボードでポジション状況確認
3. 再起動前にオープンだったポジションが正しく認識されているか

---

## 11. リスク管理の重要事項

### ボットが対応しないケース

このボットは以下の状況に自動対応しません。定期的な手動確認を推奨します:

| 状況 | 必要な対応 |
|------|-----------|
| 経済指標・重要ニュース | 必要に応じてボット停止 |
| 相場急変 (フラッシュクラッシュ等) | OANDAで手動クローズ |
| 証拠金不足アラート | ボット停止 + 入金または縮小 |
| 最大DD自動停止後 | 相場確認してから手動再起動 |

### 推奨監視頻度

- **毎日1回**: ログファイルとOANDAダッシュボードを確認
- **週1回**: 月次パフォーマンスの確認
- **相場急変時**: 即座に確認・必要に応じて停止

### ロングオンリー戦略について

このボットは **ロングのみ** のエントリーを行います。
ユーザーが手動でボットを停止するまで稼働し続けます。
相場が下降トレンドに転換したと判断したら、手動でボットを停止してください。

---

## 12. トラブルシューティング

### エラー: `config.yaml が見つかりません`

```
setup.bat を実行してください。
または手動で: copy config.example.yaml config.yaml
```

### エラー: `OANDA APIキーが無効`

```
[ERROR] 口座接続エラー: 401 Client Error
```

対処:
1. `config.yaml` の `api_key` が正しいか確認
2. OANDAダッシュボードでAPIキーを再生成
3. `environment` が口座種別と一致しているか確認
   - デモ口座 → `"practice"`
   - 本番口座 → `"live"`

### エラー: `データ不足 (N bars < 30)`

4Hデータが30本以上取得できない場合。

対処:
1. 通常は起動直後のみ発生、しばらく待てば解消
2. OANDAのサーバー障害の可能性 → 少し待ってから再起動

### ボットが停止したのにbot.pidが残っている

```cmd
del bot.pid
```

### パッケージエラー: `No module named 'oandapyV20'`

```cmd
venv\Scripts\activate.bat
pip install -r requirements_live.txt
```

### Pythonが見つからない

```
'python' は、内部コマンドまたは外部コマンド、
操作可能なプログラムまたはバッチ ファイルとして認識されていません。
```

対処: Pythonを再インストールし、「Add Python to PATH」にチェックを入れる

### エラー: `rate limit` / `connection timeout`

OANDAのAPIレート制限。`check_interval_seconds` を `120` に変更してください。

---

## 13. よくある質問 (FAQ)

**Q: 証拠金はいくら必要ですか?**

A: 最低証拠金はOANDAの規定に従います (通常数万円〜)。
バックテストは1000万円ベースで行いましたが、任意の金額で動作します。
小さい証拠金では1取引あたりの最小ユニット制限に引っかかる場合があります。

---

**Q: デモ口座で動作確認してから本番に切り替えるには?**

A: `config.yaml` の `environment` を変更します:
```yaml
environment: "live"  # "practice" から変更
```
また、本番口座の `account_id` に変更してください。

---

**Q: ボットが何日もシグナルを出さない場合は正常ですか?**

A: 正常です。SEAS_DC2d戦略はシグナルが厳選されており、
月に数回程度のエントリーが正常動作です。
バックテスト期間(2025-09〜2026-02の6ヶ月)で約15〜20トレードでした。

---

**Q: Silver (XAG_USD) はどう有効化しますか?**

A: `config.yaml` で `XAG_USD` の `enabled: true` に変更します。
ただし、先にGoldで単独テストして問題ないことを確認してから追加することを推奨します。

---

**Q: 24時間PCをつけっぱなしは電気代が心配です**

A: 低消費電力モードのPCやミニPCの使用を検討してください。
あるいは、月額数百円〜のVPS (Windows Server) でも動作します。
推奨VPS: Vultr, ConoHa Win など。

---

**Q: ポジションを手動でクローズしたらどうなりますか?**

A: 次のシグナル発生まで何もしません。
手動クローズ後も次の4Hバーでシグナルが再発生すれば新規エントリーします。

---

**Q: ボットの結果をバックテストと比較したい**

A: `scripts/backtest_maedai.py` でバックテストを実行して比較できます:
```bash
python scripts/backtest_maedai.py
```

---

## 免責事項

このソフトウェアは情報提供・教育目的のみで提供されます。
金融商品の取引には元本を超える損失が発生するリスクがあります。
過去のバックテスト結果は将来の収益を保証するものではありません。
投資判断はすべて自己責任で行ってください。
