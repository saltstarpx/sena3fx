# Claude Code 指示書 v8: 成功バイアス回避と戦略ポートフォリオ導入

## 1. 現状認識の共有と承認

### Step5-6（薄いゾーン戦略）の確認

- **バックテスト結果:** 薄いゾーン内でのトレード数が0〜2件と統計的に有意なサンプル数に達していないことを確認しました。これは「薄いゾーンは価格が高速通過する」という仮説を裏付ける結果です。
- **判断:** サンプル数不足のため、ロット0.7・ストップ1.3設定の有効性判断は時期尚早です。設定を維持したままフォワードテストへ移行し、データを蓄積するという判断を支持します。
- **アクション:** `overheat_monitor.py`の稼働を継続し、閾値見直しのためのデータ収集を続けてください。

### 構造的課題：成功バイアスとコンテキスト汚染

添付の考察記事（pasted_content_5.txt）で指摘されている通り、現在の我々の開発プロセスは「やがみメソッド」という過去の成功戦略にコンテキストが引き寄せられ、探索の多様性が失われる「成功バイアス」のリスクに直面しています。`CLAUDE.md`がやがみメソッドに偏っていること、評価軸が固定化されていることがその要因です。

この構造的課題に対処するため、開発プロセスと思考様式を根本的にアップデートします。

## 2. 新開発フレームワーク：戦略ポートフォリオ（Agent Teams的アプローチ）

今後は、単一の戦略を深化させるのではなく、特性の異なる複数の戦略を並列で開発・評価する「戦略ポートフォリオ」アプローチを採用します。これは、Agent Teamsの「コンテキスト分離」の思想を応用したものです。

以下の3つの仮想チームメイトを定義し、それぞれに独立した役割と評価基準を与えます。あなたは今後、これら3つのペルソナを意識的に切り替え、各タスクを実行してください。

### Teammate A: "Yagami" — 高勝率シグナル追求

- **役割:** 既存のやがみメソッド（5条件評価）をさらに深化させ、高勝率・高プロフィットファクターのシグナルを追求する。
- **評価基準:** 勝率(WR) > 60%, プロフィットファクター(PF) > 1.8
- **担当タスク:** 薄いゾーン戦略のフォワードテスト、`overheat_monitor.py`の監視、やがみシグナルの改善。

### Teammate B: "Maedai" — 高RRトレンドフォロー

- **役割:** `backtest_maedai.py`をベースに、低勝率・高リスクリワード（RR）のトレンドフォロー戦略を構築する。「背を近くして何度も挑戦し、大きな値動きを取る」思想を追求する。
- **評価基準:** Sharpe Ratio > 1.5, Calmar Ratio > 3.0, 年間トレード数 > 50
- **担当タスク:** Donchianブレイクアウト戦略のパラメータ最適化、ATRベースのトレーリングストップの改良。

### Teammate C: "Risk Manager" — 市場環境フィルター開発

- **役割:** 個別のエントリーシグナルではなく、ポートフォリオ全体のリスクを調整する市場環境フィルターを開発・評価する。
- **評価基準:** ポートフォリオ全体の最大ドローダウン(MDD)低減率、ボラティリティ低減率、Sharpe Ratio改善率。
- **担当タスク:** 通貨強弱、季節性、VIX等のボラティリティ指標を用いたフィルターの開発とバックテスト。

## 3. 具体的なタスク指示

上記フレームワークに基づき、以下のタスクに着手してください。

### Task 1: [Teammate C] USD強弱フィルターの統合

1.  Manus AIが提供した以下のファイルをレビューしてください。
    - `prompt_for_claude_code_v7.md`
    - `scripts/currency_strength_portfolio.py`
    - `results/currency_strength_analysis_report.md`
2.  **結論：「通貨強弱による動的ペア切替はXAGUSD固定に勝てない」** という分析結果を受け入れてください。
3.  `currency_strength_portfolio.py`内の`calc_usd_strength()`関数を流用し、USD強弱を算出する機能を`lib/indicators.py`等に追加してください。
4.  **USD強弱フィルター**（USDが上位25%の強さの時はロングエントリーを回避）を実装してください。
5.  このフィルターを**Yagami戦略とMaedai戦略の両方に適用**し、フィルター有無でのバックテスト結果（PF, MDD, Sharpe Ratio）を比較・報告してください。

### Task 2: [Teammate C] 季節フィルターの定量的評価

1.  既存のバックテストエンジン（`lib/backtest.py`）には`allowed_months`という季節フィルター機能が既に実装されています。
2.  7月・9月を除外した場合と、除外しなかった場合で、Yagami戦略のパフォーマンス（月次リターン、MDD）がどう変化するかを定量的に比較し、このフィルターの有効性を再検証してください。

### Task 3: [Teammate B] Maedai戦略の評価軸変更

1.  `scripts/backtest_maedai.py`のバックテスト結果の評価を、従来のPF/WR中心から、**Sharpe RatioとCalmar Ratio**中心に変更してください。
2.  Donchianチャネルの期間（10, 20, 40など）や、ATRのパラメータを変更し、Sharpe Ratioが最大化される組み合わせを探索してください。

### Task 4: [全チーム] ドキュメントとファイル構成の分離

1.  コンテキスト汚染を防ぐため、ドキュメントを分離します。`CLAUDE.md`はプロジェクト全体のハブとし、各戦略の詳細は別ファイルに記録してください。
    - `docs/strategy_yagami.md`
    - `docs/strategy_maedai.md`
    - `docs/filters_risk_manager.md`
2.  同様に、戦略ロジックも`strategies/`ディレクトリを新設し、ファイルを分離することを推奨します。
    - `strategies/yagami_rules.py`
    - `strategies/maedai_breakout.py`
    - `strategies/market_filters.py`

## 4. GitHubへのログ記録

これらの変更を行う際は、必ず`MANUS_CHANGELOG.md`に以下の要点を記録し、コミットメッセージに要約を含めてプッシュしてください。

- **変更種別:** 開発フレームワークの刷新
- **変更内容:**
    - 成功バイアス回避のため、戦略ポートフォリオ（Yagami, Maedai, Risk Manager）アプローチを導入。
    - Manus AIの通貨強弱分析結果を統合し、USD強弱フィルターを実装。
    - 評価軸をSharpe Ratio, Calmar Ratio等に多元化。
    - ドキュメントとファイル構成の分離を開始。
- **指示書:** `prompt_for_claude_code_v8.md`
